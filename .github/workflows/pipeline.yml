name: CI-without-DB

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
        types: [opened, synchronize]

jobs:
    pipeline:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                node-version: 20
            # Backend
            - name: Install backend dependencies
              run: npm ci
            - name: Backend lint
              run: npm run lint
            - name: Backend tests without DB
              run: npm run test:no-db
            # Frontend
            - name: Install frontend dependencies
              run: npm --prefix frontend ci
            - name: Frontend lint
              run: npm --prefix frontend run lint
            - name: Frontend tests without DB
              run: npm --prefix frontend run test:smoke
            - name: Build frontend
              run: npm --prefix frontend run build
    
    deploy:
      runs-on: ubuntu-latest
      needs: pipeline
      if: github.event_name == 'push' && github.ref == 'refs/heads/main' && !contains(toJson(github.event), '#skip')
      steps:
        - name: Deploy (Render)
          env:
            deploy_url: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
          run: curl -fsS "$deploy_url"

    notify-success:
      runs-on: ubuntu-latest
      needs: deploy
      if: ${{ needs.deploy.result == 'success' }}
      steps:
        - name: Notify Discord
          uses: hunghg255/action-notifications@master
          with:
            description: Commit [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) deployed to production.
            discord_webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
    
    notify-failure:
      runs-on: ubuntu-latest
      needs: deploy
      if: ${{ needs.deploy.result == 'failure' }}
      steps:
        - name: Notify Discord
          uses: hunghg255/action-notifications@master
          with:
            description: Deployment failed for commit [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}).
            discord_webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}

    tag_release:
      runs-on: ubuntu-latest
      needs: pipeline
      permissions:
        contents: write
      steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0
        - name: Bump version and push tag
          if: >-
            ${{ github.event_name == 'push' &&
                github.ref == 'refs/heads/main' &&
                !contains(toJson(github.event), '#skip') }}
          uses: anothrNick/github-tag-action@4ed44965e0db8dab2b466a16da04aec3cc312fd8
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            WITH_V: true
            DEFAULT_BUMP: patch

